<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Age Plotter{% endblock %}</title>
    <link rel="icon" href="data:,">

    <!-- Tailwind CSS + DaisyUI (built locally) -->
    <link href="/static/css/styles.css" rel="stylesheet" type="text/css" />

    <!-- Vendor bundle: Cytoscape, D3, HTMX, layout extensions -->
    <script src="/static/vendor/vendor.bundle.js"></script>

    {% block head %}{% endblock %}
</head>
<body class="min-h-screen bg-base-200 pb-16">
    <main class="container mx-auto p-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Bottom navbar -->
    <div class="navbar bg-base-100 shadow-lg fixed bottom-0 left-0 right-0 z-50">
        <div class="flex-1">
            <a href="/" class="btn btn-ghost text-xl">Age Plotter</a>
        </div>
        <div class="flex-none">
            <select id="theme-select" class="select select-sm select-bordered" onchange="setTheme(this.value)">
                <option value="light">Light</option>
                <option value="dark" selected>Dark</option>
                <option value="cupcake">Cupcake</option>
                <option value="bumblebee">Bumblebee</option>
                <option value="emerald">Emerald</option>
                <option value="corporate">Corporate</option>
                <option value="synthwave">Synthwave</option>
                <option value="retro">Retro</option>
                <option value="cyberpunk">Cyberpunk</option>
                <option value="valentine">Valentine</option>
                <option value="halloween">Halloween</option>
                <option value="garden">Garden</option>
                <option value="forest">Forest</option>
                <option value="aqua">Aqua</option>
                <option value="lofi">Lo-Fi</option>
                <option value="pastel">Pastel</option>
                <option value="fantasy">Fantasy</option>
                <option value="wireframe">Wireframe</option>
                <option value="black">Black</option>
                <option value="luxury">Luxury</option>
                <option value="dracula">Dracula</option>
                <option value="cmyk">CMYK</option>
                <option value="autumn">Autumn</option>
                <option value="business">Business</option>
                <option value="acid">Acid</option>
                <option value="lemonade">Lemonade</option>
                <option value="night">Night</option>
                <option value="coffee">Coffee</option>
                <option value="winter">Winter</option>
                <option value="dim">Dim</option>
                <option value="nord">Nord</option>
                <option value="sunset">Sunset</option>
            </select>
        </div>
    </div>

    <!-- Hidden elements to sample DaisyUI colors -->
    <div id="theme-sampler-bg" class="bg-base-100" style="position:absolute;left:-9999px;width:1px;height:1px;"></div>
    <div id="theme-sampler-text" class="text-base-content" style="position:absolute;left:-9999px;width:1px;height:1px;"></div>
    <div id="theme-sampler-primary" class="bg-primary" style="position:absolute;left:-9999px;width:1px;height:1px;"></div>

    <script>
    const darkThemes = ['dark', 'synthwave', 'halloween', 'forest', 'black',
        'luxury', 'dracula', 'business', 'night', 'coffee', 'dim', 'sunset'];

    function cssColorToHex(cssColor) {
        // Use canvas to convert any CSS color (including oklch) to hex
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = 1;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = cssColor;
        ctx.fillRect(0, 0, 1, 1);
        const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
        return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
    }

    function blendColors(hex1, hex2, ratio) {
        // Blend two hex colors: ratio=0 returns hex1, ratio=1 returns hex2
        const r1 = parseInt(hex1.slice(1, 3), 16);
        const g1 = parseInt(hex1.slice(3, 5), 16);
        const b1 = parseInt(hex1.slice(5, 7), 16);
        const r2 = parseInt(hex2.slice(1, 3), 16);
        const g2 = parseInt(hex2.slice(3, 5), 16);
        const b2 = parseInt(hex2.slice(5, 7), 16);
        const r = Math.round(r1 + (r2 - r1) * ratio);
        const g = Math.round(g1 + (g2 - g1) * ratio);
        const b = Math.round(b1 + (b2 - b1) * ratio);
        return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
    }

    function getThemeColors() {
        const bgSampler = document.getElementById('theme-sampler-bg');
        const textSampler = document.getElementById('theme-sampler-text');
        const primarySampler = document.getElementById('theme-sampler-primary');
        const rawBg = bgSampler ? getComputedStyle(bgSampler).backgroundColor : null;
        const rawText = textSampler ? getComputedStyle(textSampler).color : null;
        const rawPrimary = primarySampler ? getComputedStyle(primarySampler).backgroundColor : null;
        const bg = rawBg ? cssColorToHex(rawBg) : null;
        const text = rawText ? cssColorToHex(rawText) : null;
        const primary = rawPrimary ? cssColorToHex(rawPrimary) : null;
        // Muted = text blended 50% toward background (for edges)
        const muted = (bg && text) ? blendColors(text, bg, 0.5) : null;
        // Dimmed = text blended 80% toward background (for inactive elements)
        const dimmed = (bg && text) ? blendColors(text, bg, 0.8) : null;
        return { bg, text, primary, muted, dimmed };
    }

    function updateMonacoTheme() {
        if (!window.monaco || !window.monacoEditor) return;

        const theme = localStorage.getItem('age_plotter_theme') || 'dark';
        const isDark = darkThemes.includes(theme);
        const colors = getThemeColors();

        // Define custom theme matching DaisyUI background
        monaco.editor.defineTheme('daisy-theme', {
            base: isDark ? 'vs-dark' : 'vs',
            inherit: true,
            rules: [],
            colors: colors.bg ? { 'editor.background': colors.bg } : {}
        });
        monaco.editor.setTheme('daisy-theme');
    }

    function updateCytoscapeTheme() {
        const colors = getThemeColors();
        if (!colors.text) return;

        // Store colors globally for filter functions
        window.themeColors = colors;

        // Update all Cytoscape instances
        document.querySelectorAll('.cytoscape-container').forEach(container => {
            const cy = container._cy;
            if (cy) {
                cy.style()
                    .selector('node').style('color', colors.text)
                    .selector('edge').style({
                        'line-color': colors.muted,
                        'target-arrow-color': colors.muted,
                        'color': colors.muted
                    })
                    .update();
            }
        });
    }

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('age_plotter_theme', theme);
        setTimeout(() => {
            updateMonacoTheme();
            updateCytoscapeTheme();
        }, 50);
    }

    // Restore saved theme on load
    (function() {
        const saved = localStorage.getItem('age_plotter_theme');
        if (saved) {
            document.documentElement.setAttribute('data-theme', saved);
            const select = document.getElementById('theme-select');
            if (select) select.value = saved;
        }
    })();
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
